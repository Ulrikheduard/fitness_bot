import asyncio
from datetime import datetime, timedelta
from config import DAILY_HOUR, DAILY_MINUTE, EVENING_HOUR, EVENING_MINUTE
from keyboards import action_keyboard
from database import (
    reset_monthly_day_off,
    get_users_without_task_today,
    get_expired_duels,
    resolve_duel,
    get_duel,
    get_user,
    update_score,
)

# –ü—Ä–∏–º–µ—Ä –Ω–∞–±–æ—Ä–∞ —Ü–∏—Ç–∞—Ç
QUOTES = [
    "–î–µ–ª–∞–π –∫–∞–∫ —É–º–µ–µ—à—å. –õ—É—á—à–µ –Ω–µ –≤—ã–π–¥–µ—Ç.",
    "–ú—ã—Å–ª–∏ –µ—Å—Ç—å, —Å–º—ã—Å–ª–∞ –Ω–µ—Ç.",
    "–ù–µ –∂–¥–∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏. –ï—ë –Ω–∏–∫—Ç–æ –Ω–µ —Å–æ–±–∏—Ä–∞–ª—Å—è –ø—Ä–∏—Å—ã–ª–∞—Ç—å.",
    "–ü—Ä–æ—Å—ã–ø–∞–π—Å—è, —á–µ–º–ø–∏–æ–Ω‚Ä¶ –ø–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏—é –≤—Å–µ–≥–æ –Ω–∞ –ø–æ—Ç–æ–º.",
    "–£—Ç—Ä–æ –¥–æ–±—Ä–æ–µ ‚Äî –Ω–æ –Ω–µ –¥–ª—è —Ç–µ–±—è. –î–µ–ª–∞–π –æ—Ç–∂–∏–º–∞–Ω–∏—è.",
    "–õ–µ–Ω—å ‚Äî —ç—Ç–æ —Ç–∞–ª–∞–Ω—Ç. –ù–æ –¥–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –≤–∏–¥, —á—Ç–æ –º—ã –ø—Ä–æ—Ç–∏–≤.",
    "–ü–µ—Ä–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ —É—Å–ø–µ—Ö–∞: –Ω–∞—á–Ω–∏. –•–æ—Ç—è –±—ã —Å–¥–µ–ª–∞–π –≤–∏–¥.",
    "–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –±—ã—Ç—å —Å–∏–ª—å–Ω—ã–º ‚Äî –±—É–¥—å. –ê –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ç–æ–∂–µ –±—É–¥—å, –ø—Ä–æ—Å—Ç–æ —Å–ª–∞–±—ã–º.",
    "–°–µ–≥–æ–¥–Ω—è —Ç—ã –º–æ–∂–µ—à—å –≤—Å—ë. –ù–æ –Ω–∞—á–Ω–∏ —Ö–æ—Ç—è –±—ã —Å –æ–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.",
    "–° –∫–∞–∂–¥—ã–º –æ—Ç–∂–∏–º–∞–Ω–∏–µ–º —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –ª—É—á—à–µ. –ù–æ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, –Ω–µ –æ–±–æ–ª—å—â–∞–π—Å—è.",
    "–ï—Å–ª–∏ —É—Å—Ç–∞–ª ‚Äî –æ—Ç–¥–æ—Ö–Ω–∏. –ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–ª ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–¥–æ—Ö–Ω–∏.",
    "–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–µ —Ä–µ—à–∞—Ç –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –¥–∞–¥—É—Ç –≤—Ä–µ–º—è –Ω–µ –¥—É–º–∞—Ç—å –æ –Ω–∏—Ö.",
    "–£ —Ç–µ–±—è –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏? –û—Ç–ª–∏—á–Ω–æ, —Å–¥–µ–ª–∞–π –±—ã—Å—Ç—Ä–æ.",
    "–ò–¥–µ–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç? –û–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –î–µ–ª–∞–π —Å–µ–π—á–∞—Å.",
    "–ù–µ —Ö–æ—á–µ—à—å? –ü–æ–Ω–∏–º–∞—é. –ù–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–ª–∞–π.",
    "–ë—É–¥—É—â–µ–µ –≤ —Ç–≤–æ–∏—Ö —Ä—É–∫–∞—Ö. –ù–æ —Å–Ω–∞—á–∞–ª–∞ –ø—É—Å—Ç—å —Ä—É–∫–∏ –≤—ã–¥–µ—Ä–∂–∞—Ç —Ç–≤–æ—ë —Ç–µ–ª–æ.",
    "–¢—ã –º–æ–∂–µ—à—å –±–æ–ª—å—à–µ, —á–µ–º —Ç–µ–±–µ –ª–µ–Ω—å.",
    "–°–ª–∞–±–æ—Å—Ç—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –Ω–µ –º–æ–∂–µ—à—å. –õ–µ–Ω—å ‚Äî –∫–æ–≥–¥–∞ –Ω–µ —Ö–æ—á–µ—à—å. –£–≥–∞–¥–∞–π, —á—Ç–æ —É —Ç–µ–±—è?",
    "–°–¥–µ–ª–∞–π –æ—Ç–∂–∏–º–∞–Ω–∏—è. –ú–∏—Ä –Ω–µ —Å—Ç–∞–Ω–µ—Ç –ª—É—á—à–µ, –Ω–æ —Ç—ã ‚Äî –¥–∞. –ß—É—Ç–∫–∞.",
    "–ú–æ—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–¥—ë—Ç. –ü–æ—Å–ª–µ –æ—Ç–∂–∏–º–∞–Ω–∏–π. –í–æ–∑–º–æ–∂–Ω–æ.",
    "–ù–µ –±—É–¥—å —Å–ª–∞–±—ã–º. –≠—Ç–æ –º–µ—Å—Ç–æ —É–∂–µ –∑–∞–Ω—è—Ç–æ.",
    "–ï—Å–ª–∏ –º–∏—Ä –¥–∞–≤–∏—Ç ‚Äî –æ—Ç–æ–∂–º–∏—Å—å –∏ –¥–∞–π –µ–º—É —Å–¥–∞—á–∏.",
    "–ë–æ–π—Å—è –Ω–µ –ø–∞–¥–µ–Ω–∏–π, –∞ —Ç–æ–≥–æ, —á—Ç–æ —Ç–∞–∫ –∏ –Ω–µ –ø–æ–¥–Ω–∏–º–µ—à—å—Å—è.",
    "–ù–µ—Ç –ø–ª–æ—Ö–∏—Ö –¥–Ω–µ–π. –ï—Å—Ç—å –¥–Ω–∏, –∫–æ–≥–¥–∞ —Ç—ã –Ω–µ —Å–¥–µ–ª–∞–ª –ø–æ–¥—Ö–æ–¥.",
    "–ù–µ —Ö–æ—á–µ—à—å? –û—Ç–ª–∏—á–Ω–æ. –ó–Ω–∞—á–∏—Ç, –∏–º–µ–Ω–Ω–æ —Å–µ–≥–æ–¥–Ω—è –∏ –Ω—É–∂–Ω–æ.",
    "–ò–Ω–æ–≥–¥–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ¬´—è –≤—Å—ë –∂–µ —Å–¥–µ–ª–∞–ª¬ª.",
    "–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å ‚Äî —Å–¥–µ–ª–∞–π. –ï—Å–ª–∏ –º–æ–∂–µ—à—å ‚Äî —Å–¥–µ–ª–∞–π –¥–≤–∞–∂–¥—ã.",
    "–¢—ã –Ω–µ –æ–±—è–∑–∞–Ω –±—ã—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º. –¢—ã –æ–±—è–∑–∞–Ω –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.",
    "–õ–µ–∂–∏—à—å? –û—Ç–ª–∏—á–Ω–æ. –¢—ã –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.",
    "–¢–≤–æ—ë –±—É–¥—É—â–µ–µ –Ω–µ –æ–±–∏–¥–∏—Ç—Å—è, –µ—Å–ª–∏ —Ç—ã –Ω–∏—á–µ–≥–æ –Ω–µ —Å–¥–µ–ª–∞–µ—à—å. –û–Ω–æ –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ—Ç —Ç–∞–∫–∏–º –∂–µ —É–Ω—ã–ª—ã–º.",
    "–°—É–¥—å–±–∞ –ª—é–±–∏—Ç —Å–º–µ–ª—ã—Ö. –ê –ø–æ–∫–∞ –æ–Ω–∞ —Ç–µ–±—è –∂–∞–ª–µ–µ—Ç.",
    "–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏—è ‚Äî —ç—Ç–æ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞. –ù–æ –≤ –º–∏–Ω—É—Å.",
    "–¢—ã –ª—É—á—à–µ, —á–µ–º –±—ã–ª –≤—á–µ—Ä–∞. –ù–æ —ç—Ç–æ –±—ã–ª–∞ –Ω–∏–∑–∫–∞—è –ø–ª–∞–Ω–∫–∞.",
    "–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã —Å–¥–∞—ë—à—å—Å—è, —Ç–≤–æ—è –ª–µ–Ω—å –ø–æ–ª—É—á–∞–µ—Ç +1 –∫ —É—Ä–æ–≤–Ω—é.",
    "–ï—Å–ª–∏ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–æ–±–æ–π –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ ‚Äî –∑–Ω–∞—á–∏—Ç, –¥–∞–≤–Ω–æ –ø–æ—Ä–∞.",
    "–ú–∏—Ä –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤. –ù–æ –≤ –æ—Ç–∂–∏–º–∞–Ω–∏—è—Ö —Ö–æ—Ç—è –±—ã –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª–∞.",
    "–í—Å—Ç–∞–Ω—å. –°–¥–µ–ª–∞–π. –£–ø–∞–¥–∏. –í—Å—Ç–∞–Ω—å —Å–Ω–æ–≤–∞. –≠—Ç–æ —Ç–≤–æ—è –Ω–æ–≤–∞—è —Å—É–ø–µ—Ä—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.",
    "–ú–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ —Å–µ–≥–æ–¥–Ω—è ‚Äî –æ–≥—Ä–æ–º–Ω—ã–π ¬´–Ω—É —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ¬ª –∑–∞–≤—Ç—Ä–∞.",
]


async def daily_reminder(bot, chat_id):
    last_reset_month = 0
    last_sent_date = None
    last_weekly_check_day = None

    while True:
        now = datetime.now()
        today = now.date()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å day off (–≤ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞)
        current_month_key = now.year * 100 + now.month
        if now.day == 1 and current_month_key != last_reset_month:
            try:
                await reset_monthly_day_off()
                print(
                    f"‚úÖ Day Off —Å–±—Ä–æ—à–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–º–µ—Å—è—Ü: {now.month}/{now.year})"
                )
                last_reset_month = current_month_key
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ Day Off: {e}")

        # –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        target = now.replace(
            hour=DAILY_HOUR, minute=DAILY_MINUTE, second=0, microsecond=0
        )
        if now > target:
            target += timedelta(days=1)

        sleep_seconds = (target - now).total_seconds()
        await asyncio.sleep(sleep_seconds)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è
        current_date = datetime.now().date()
        if last_sent_date != current_date:
            quote = QUOTES[datetime.now().day % len(QUOTES)]
            try:
                await bot.send_message(
                    chat_id=chat_id,
                    text=f"üåû <b>–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –º—É–∂–∏–∫–∏!</b>\n\n{quote} ü§î\n\n<b>–£—Å–ª–æ–≤–∏—è –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é: 40 –æ—Ç–∂–∏–º–∞–Ω–∏–π.</b>\n\n–ù–∞–∂–∏–º–∞–π /task –∏ –ø—Ä–∏—Å—ã–ª–∞–π –≤–∏–¥–µ–æ —Å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏!\n\n",
                    parse_mode="HTML",
                    reply_markup=None,
                )
                last_sent_date = current_date
            except Exception as e:
                print("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", e)


async def evening_reminder(bot, chat_id):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ—á–µ—Ä–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ 22:00 –æ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è—Ö"""
    last_sent_evening = None

    while True:
        now = datetime.now()
        today = now.date()

        # –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –≤–µ—á–µ—Ä–Ω–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        target = now.replace(
            hour=EVENING_HOUR, minute=EVENING_MINUTE, second=0, microsecond=0
        )
        if now > target:
            target += timedelta(days=1)

        sleep_seconds = (target - now).total_seconds()
        await asyncio.sleep(sleep_seconds)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ –≤–µ—á–µ—Ä–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è
        current_date = datetime.now().date()
        if last_sent_evening != current_date:
            try:
                # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
                users_without_task = await get_users_without_task_today()

                # –ï—Å–ª–∏ –µ—Å—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if users_without_task:
                    names_list = "\n".join(
                        [f"‚Ä¢ {name}" for user_id, name in users_without_task]
                    )

                    message_text = (
                        f"üö® <b>ALARM! –í–µ—á–µ—Ä–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!</b>\n\n"
                        f"–°–µ–≥–æ–¥–Ω—è —Å–ª–µ–¥—É—é—â–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:\n\n"
                        f"{names_list}\n\n"
                        f"–ü–∞—Ü–∞–Ω—ã, —É –≤–∞—Å –µ—â—ë –µ—Å—Ç—å –≤—Ä–µ–º—è! –£–ø–æ—Ä –ª–µ–∂–∞ –ø—Ä–∏–Ω–∏–º–∞–µ–º, –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ–º!üèãüèº‚Äç‚ôÄÔ∏è"
                    )

                    await bot.send_message(
                        chat_id=chat_id, text=message_text, parse_mode="HTML"
                    )
                    print(
                        f"‚úÖ –í–µ—á–µ—Ä–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–µ–∑ –∑–∞–¥–∞–Ω–∏—è: {len(users_without_task)}"
                    )
                else:
                    print(
                        "‚úÖ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ. –í–µ—á–µ—Ä–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
                    )

                last_sent_evening = current_date
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–µ—á–µ—Ä–Ω–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")


async def nightly_check(bot, chat_id):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –ø–æ–ª–Ω–æ—á—å –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –¥–µ–Ω—å –æ—Ç–¥—ã—Ö–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"""
    last_check_date = None

    while True:
        now = datetime.now()
        today = now.date()

        # –í—ã—á–∏—Å–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (00:01)
        target = now.replace(hour=0, minute=1, second=0, microsecond=0)
        if now > target:
            target += timedelta(days=1)

        sleep_seconds = (target - now).total_seconds()
        await asyncio.sleep(sleep_seconds)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –ª–∏ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Å–µ–≥–æ–¥–Ω—è
        current_date = datetime.now().date()
        if last_check_date != current_date:
            try:
                from database import auto_apply_dayoff_for_incomplete_tasks

                result = await auto_apply_dayoff_for_incomplete_tasks()

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ
                if result["auto_dayoff_applied"]:
                    names_list = "\n".join(
                        [
                            f"‚Ä¢ {item['name']} (–æ—Å—Ç–∞–ª–æ—Å—å Day Off: {item['remaining']}/3)"
                            for item in result["auto_dayoff_applied"]
                        ]
                    )

                    message_text = (
                        f"‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Day off\n\n"
                        f"C–ª–µ–¥—É—é—â–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—ë–Ω day off "
                        f"(–æ–Ω–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –≤—á–µ—Ä–∞):\n\n"
                        f"{names_list}\n\n"
                        f"–°–µ–≥–æ–¥–Ω—è –∏–º –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂!"
                    )

                    await bot.send_message(chat_id=chat_id, text=message_text)
                    print(
                        f"‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π day off –ø—Ä–∏–º–µ–Ω—ë–Ω –¥–ª—è {len(result['auto_dayoff_applied'])} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
                    )

                if result["eliminated"]:
                    names_list = "\n".join(
                        [f"‚Ä¢ {item['name']}" for item in result["eliminated"]]
                    )

                    message_text = (
                        f"‚ùå –£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—ã–±—ã–ª–∏ –∏–∑ —á–µ–ª–ª–µ–Ω–¥–∂–∞\n\n"
                        f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤—Å–µ 3 –¥–Ω—è –æ—Ç–¥—ã—Ö–∞ –∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤—á–µ—Ä–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:\n\n"
                        f"{names_list}\n\n"
                        f"–£–≤–∏–¥–∏–º—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ! üëã"
                    )

                    await bot.send_message(chat_id=chat_id, text=message_text)
                    print(
                        f"‚úÖ –ò–∑ —á–µ–ª–ª–µ–Ω–¥–∂–∞ –∏—Å–∫–ª—é—á–µ–Ω—ã {len(result['eliminated'])} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
                    )

                if not result["auto_dayoff_applied"] and not result["eliminated"]:
                    print(
                        "‚úÖ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ day off. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
                    )

                last_check_date = current_date
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –Ω–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏: {e}")


async def check_expired_duels(bot, chat_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å—Ç–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥—É—ç–ª–µ–π –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç"""
    while True:
        try:
            expired_duels = await get_expired_duels()

            for duel in expired_duels:
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –¥—É—ç–ª—å –≤ –ø–æ–ª—å–∑—É –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ
                await resolve_duel(
                    duel["id"], "challenger_won", duel["challenger_id"], None
                )

                # –ù–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
                await update_score(duel["challenger_id"], 2)
                await update_score(duel["opponent_id"], -2)

                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
                challenger = await get_user(duel["challenger_id"])
                opponent = await get_user(duel["opponent_id"])

                # –£–≤–µ–¥–æ–º–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –æ–±—â–∏–π —á–∞—Ç
                try:
                    from config import CHAT_ID

                    challenger_name = challenger.get("name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
                    opponent_name = opponent.get("name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
                    await bot.send_message(
                        chat_id=CHAT_ID,
                        text=(
                            f"‚öîÔ∏è <b>–î–£–≠–õ–¨ –ó–ê–í–ï–†–®–ï–ù–ê</b>\n\n"
                            f"–°–æ–ø–µ—Ä–Ω–∏–∫ –Ω–µ —É—Å–ø–µ–ª –ø—Ä–∏—Å–ª–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.\n\n"
                            f"üèÜ <b>{challenger_name}</b> –ø–æ–±–µ–¥–∏–ª! –ü–æ–ª—É—á–µ–Ω–æ +2üí™\n"
                            f"üíî <b>{opponent_name}</b> –ø—Ä–æ–∏–≥—Ä–∞–ª. –ü–æ—Ç–µ—Ä—è–Ω–æ -2üí™"
                        ),
                        parse_mode="HTML",
                    )
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –¥—É—ç–ª–∏: {e}")

                print(
                    f"‚úÖ –î—É—ç–ª—å {duel['id']} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ –ø–æ–ª—å–∑—É {challenger['name']}"
                )

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
            await asyncio.sleep(300)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –¥—É—ç–ª–µ–π: {e}")
            await asyncio.sleep(300)
